{% extends "recurring_payments/base.html" %}
{% load base_tags %}
{% load base_filters %}
{% load perm_tags %}
{% load i18n %}

{% block title %}Recurring Payment View{% endblock %}

{% block extra_head %}
{{ block.super }}

<link type="text/css" href="/site_media/static/css/jquery-ui/tabs/ui-1.8.tabs.css" rel="stylesheet" />	
<link type="text/css" href="{{ STATIC_URL }}tablesorter/sortthemes.css" rel="Stylesheet" />	

<style>
	#rpview-tabs{
		margin-top: 1em;
	}

	.l0{
	    background-color: #D2D2D2;
	    border: 0 none;
	    height: 1px;
	    margin: 1em 0;
	    width: 90%;
	}
	
	.section-header{
		font-size: 1.2em;
		font-weight: bold;
		padding: 0.5em 0;
	}
	.rp-body div{
		padding: 3px 0;
	}
	.body-bold{
		font-weight: bold;
	}
	.transaction-success{
		color: green;
	}
	.transaction-failed{
		color: red;
	}

</style>

{% endblock %}

{% block body %}
 {% is_admin request.user as isadmin %}
 
<div class="t">
<div id="t-rp">
<div id="t-view">
	
	    <h1>Recurring Payment Account for <a href="{% url profile rp.user.username %}">{{ rp.user }}</a></h1>
	    <div style="color:#669900">Service Name: {{ rp.description }}</div>
	    
	  
	  <div id="rpview-tabs">
	      <ul>
	         <li><a href="#rpview-overview" id="overview"><span>{% trans "Overview" %}</span></a></li>
	          
	         <li><a href="#rpview-invoices" id="invoices"><span>{% trans "Invoices" %}</span></a></li>
	          
	         <li><a href="#rpview-transactions" id="transactions"><span>{% trans "Transaction History" %}</span></a></li>
                
	       </ul>
	   </div>
	    
	<div id="rpview-overview">
  		<div class="basic-info">
  		Current account balance: <span class="body-bold">{{ rp.get_outstanding_balance|format_currency }}</span>
  		<br />
  		<br />
  		
  		{% if last_paid_payment_transaction %}
  				The last payment (<span class="body-bold">{{ last_paid_payment_transaction.amount|format_currency }}</span>)
  				received date:  {{ last_paid_payment_transaction.create_dt  }}.
		  		<br />
  				<br />
  		{% endif %}
  		
  		
  		{% if last_failed_payment_transaction %}
  				The last payment ({{ last_paid_payment_transaction.amount|format_currency }})
  				was failed on {{ last_failed_payment_transaction.create_dt|date  }}.
  				
  				<br />
  				<br />
  		{% endif %}
  		
  		The number of billing cycle completed: <span class="body-bold">{{ rp.num_billing_cycle_completed }}</span>
  		<br />
  		<br />
  		The number of billing cycle failed: {{ rp.num_billing_cycle_failed }}
  		
  		</div>
  		
  		<div class="l0"></div>
  		
  		<div class="section-header">Recurring Billing Settings</div>
  		
  		<div class="rp-body">
		<div >Payment Amount: <span class="body-bold">{{ rp.payment_amount|format_currency }}</span></div>
	
		<div>Initial Billing Cycle Start Date: <span class="body-bold">{{ rp.billing_start_dt }}</span></div>
	
		<div>Billing Frequency: <span class="body-bold">Once every {{ rp.billing_frequency }} 
		{{ rp.billing_period }}{{ rp.billing_frequency|pluralize }}</span></div>
	
		<div>Billing Date: <span class="body-bold">{{ rp.num_days }} day{{ rp.num_days|pluralize }}  after each billing cycle end date</span></div>
	
  		</div>
  		
  		{% if rp.has_trial_period %}
	  		<div class="l0"></div>
	  		<div class="section-header">Trial Period</div>
	  		<div class="rp-body">
		  		<div>Amount: <span class="body-bold">{{ rp.trial_amount|format_currency }}</span></div>
		  		<div>From {{ rp.trial_period_start_dt|date }} to {{ rp.trial_period_end_dt|date }}</div>
		  	</div>
		  		
  		{% endif %}
		
    </div>
    
    
    

	<div id="rpview-invoices">
	{% if rp_invoices %}
		<table width="90%" class="tablesorter">
			<thead>
			<tr>
				<th class="iheader">Billing Cycle</th>
				<th class="iheader">Amount</th>
				<th class="iheader">Due Date</th>
				<th class="iheader">Payment Received Date</th>
				<th class="iheader">Paid?</th>
				<th class="iheader">Invoice #</th>
			</tr>
			</thead>
			<tbody>
			{% for rp_invoice in  rp_invoices %}
				<tr>
					<td>{{ rp_invoice.billing_cycle_start_dt|date:"n/j/Y" }} - {{ rp_invoice.billing_cycle_end_dt|date:"n/j/Y" }}</td>
					<td>{{ rp_invoice.invoice.total|format_currency }} </td>
					<td>{{ rp_invoice.billing_dt|date:"n/j/Y" }}</td>
					<td>{% if rp_invoice.payment_received_dt %}{{ rp_invoice.payment_received_dt|date:"n/j/Y" }}{% endif %}</td>
					<td>{% if rp_invoice.invoice.balance <= 0 %}Y{% else %}N{% endif %}</td>
					<td><a href="" title="view invoice" target="_blank">{{ rp_invoice.invoice.id }}</a></td>
				</tr>
			{% endfor %}
			</tbody>
		</table>	
	{% else %}	
		No invoices available yet. 
	{% endif %}	
	</div>
	
	<div id="rpview-transactions">
	
	{% if payment_transactions %}
		<table width="90%" class="tablesorter" id="#transtable">
			<thead>
			<tr>
				<th class="iheader">Date</th>
				<th class="iheader">Invoice #</th>
				<th class="iheader">Amount</th>
				<th class="iheader">Result</th>
				<th class="iheader">Reason if Failed</th>
				<th class="iheader">View Receipt</th>
			</tr>
			</thead>
			<tbody>
			{% for pt in  payment_transactions %}
				<tr>
					<td>{{ pt.create_dt|date:"n/j/Y" }}</td>
					<td><a href="" title="view invoice" target="_blank">{{ pt.recurring_payment_invoice.invoice.id }}</a></td>
					<td>{{ pt.amount|format_currency }} </td>
					<td>{% if pt.status  %}<span class="transaction-success">Success</span>{% else %}<span class="transaction-failed">Failed</span>{% endif %}</td>
					<td>{% if not pt.status %}{{ pt.message_text }}{% endif %}</td>
					<td><a href="" title="view receipt" target="_blank">{{ pt.payment.id }}</a></td>
				</tr>
			{% endfor %}
			</tbody>
		</table>	
	{% else %}	
		No payment transactions available yet. 
	{% endif %}	
		
	</div>

</div>
</div>
</div>

{% endblock %}

{% block extra_body %}
{{ block.super }}
{# dynamically load jquery #}
<script>
	if (!(window.jQuery)) { 
		var s = document.createElement('script');
		s.setAttribute('src', '/site_media/static/js/jquery-1.4.2.min.js'); 
		s.setAttribute('type', 'text/javascript');
		document.getElementsByTagName('head')[0].appendChild(s);}
</script>
<script type="text/javascript" src="/site_media/static/js/jquery_tabs/jquery-ui-1.8.custom.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}tablesorter/jquery.tablesorter.min.js"></script> 
<script type="text/javascript">
$(document).ready(function(){
    if(document.location.hash != ""){window.scrollTo(0,0);}
	var $tabs = $("#rpview-tabs").tabs();
	
	// extend the default setting to always include the zebra widget. 
        $.tablesorter.defaults.widgets = ['zebra']; 
        // extend the default setting to always sort on the first column 
        $.tablesorter.defaults.sortList = [[0,1]]; 
        // call the tablesorter plugin 
        $("table").tablesorter({
             headers: { 
            // assign the first column (we start counting zero) 
            0: { 
                // disable it by setting the property sorter to false 
                //sorter: false 
                } 
            } 
        }); 
	
}); 


</script>

{% endblock %}
