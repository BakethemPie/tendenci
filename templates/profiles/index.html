{% extends "profiles/base.html" %}
{% load avatar_tags %}
{% load base_tags %}
{% load base_filters %}
{% load perm_tags %}
{% load profile_tags %}
{% load contribution_tags %}
{% load membership_tags %}
{% load i18n %}

{% assign can_edit_user profile|args:request.user|call:'allow_edit_by' %}
{% is_admin request.user as isadmin %}

{% block title %}Profile View{% endblock %}

{% block extra_head %}
{{ block.super }}
<link rel="stylesheet" href="/site_media/static/css/iconrow.css">
<link rel="stylesheet" href="/site_media/static/css/profiles.css">
<link type="text/css" href="/site_media/static/css/jquery-ui/tabs/ui-1.8.tabs.css" rel="stylesheet" />	
{% endblock %}

{% block body %}
<div class="t">
<div id="t-profile"><div id="t-view">
	{% users_nav request.user user_this %}
	
    <h1>{{ user_this.get_full_name }}({{ user_this.username }})</h1>
    {% users_options request.user user_this %}
    <div class="clear-right"></div>
	  
    <div id="userview-tabs">
        <ul>
            <li><a href="#userview-profile" id="profile"><span>{% trans "Profile" %}</span></a></li>
            {%if user_this.is_active %}
            <li><a href="#userview-contributions" id="contributions"><span>{% trans "Contributions" %}</span></a></li>
            {%endif %}
            <li><a href="#userview-groups" id="groups"><span>{% trans "Groups" %}</span></a></li>
            <li><a href="#userview-memberships" id="memberships"><span>{% trans "Memberships" %}</span></a></li>
       </ul>
    </div>
	    
	 <div id="userview-profile">
	    <div class="profile-left">
	    <div class="profile-icon"><a href="{% url profile.change_avatar  user_this.id %}">{% avatar user_this 128 %}</a></div>
	    
	    {% if can_edit_user %}
	    	<small><a href="{% url profile.change_avatar  user_this.id %}">{% trans "Change Picture" %}</a></small>
	    {%endif%}
	    
	    {% if content_counts.total > 0 %}
	   		<div class="module-content">
		   		<h2>{% if request.user.id == user_this.id %}My{% else %}{{ user_this.first_name }}'s{% endif %} {% trans "Content" %}</h2>
		   		<div class="option-links">
		   			{% if content_counts.invoice > 0 %}
		   				<a href="{% url invoice.search %}?bill_to={{ user_this.last_name }}">{% trans "Invoices" %} ({{ content_counts.invoice }})</a>
		   			{% endif %}
		   		</div>
	   		</div>
	    {% endif %}
	    
	    </div>
	    
	    <div class="profile-right">
	    	<div class="contact-info profile-section">
		    <h2>{% trans "Contact Info" %}</h2>
		    	<table class="section-items">
			    {% if user_this.email or profile.email2 %}
			    	<tr>
				    	<td class="type">Email:</td> <td class="items">
				    	{% if user_this.email  %}
					    	<span class="item">
					    		{{user_this.email|obfuscate_email }}
					    	</span>
				    	{% endif %}
				    	{% if profile.email2  %}
					    	<span class="item">
					    		{{profile.email2|obfuscate_email }}
					    	</span>
				    	{% endif %}
				    	</td>
			    	</tr>
			    {%endif%}
			    {% if profile.phone or profile.phone2 or profile.work_phone or profile.home_phone or profile.mobile_phone %}
			    	<tr>
			    	<td class="type">{% trans "Phone:" %}</td> 
				    	<td class="items"> 
				    	{% if profile.phone  %}
					    	<span class="item">
					    		{{profile.phone}} 
					    	</span>
				    	{% endif %}
				    	
				    	{% if profile.phone2  %}
					    	<span class="item">
					    		{{profile.phone2 }} 
					    	</span>
				    	{% endif %}
				    	
				    	{% if profile.work_phone  %}
					    	<span class="item">
					    		{{profile.work_phone }} 
					    	</span>
				    	{% endif %}
				    	
				    	{% if profile.home_phone  %}
					    	<span class="item">
					    		{{profile.home_phone }} 
					    	</span>
				    	{% endif %}
				    	
				    	{% if profile.mobile_phone  %}
					    	<span class="item">
					    		{{profile.mobile_phone }} 
					    	</span>
				    	{% endif %}
				    	
				    	</td>
			    	</tr>
			    {%endif%}
			    
			    {% if profile.fax %}
			    	<tr>
				    	<td class="type">{% trans "Fax:" %}</td> <td class="items">
				    	{% if profile.fax  %}
					    	<span class="item">
					    		{{profile.fax}}
					    	</span>
				    	{% endif %}
				    	</td>
			    	</tr>
			    {%endif%}
			    
			     {% if profile.url or profile.url2 %}
			    	<tr>
				    	<td class="type">{% trans "Website:" %}</td> <td class="items">
				    	{% if profile.url  %}
					    	<span class="item">
					    		{{profile.url|urlize}}
					    	</span>
				    	{% endif %}
				    	{% if profile.url2  %}
					    	<span class="item">
					    		{{profile.url2|urlize}}
					    	</span>
				    	{% endif %}
				    	</td>
			    	</tr>
			    {%endif%}
			    
			  </table>
			</div>
			
			{% if can_edit_user or not profile.hide_address %}
				{% if profile.mailing_name or profile.address or profile.city or profile.state or profile.zipcode or profile.country  %} 
				  <div class="profile-addresses profile-section">
					  <h2>{% trans "Addresses" %}</h2>
				    	<div class="user-address">
					    	{% if profile.mailing_name %}
						    	<span class="mailing-name">{{profile.mailing_name}}</span>
						    {%endif%}
						    <address class="adr">
							    {% if profile.address %}
							    	<span class="street-address">{{profile.address}}
							    	{% if profile.address2 %}{{profile.address}} {%endif%}
							    	</span>
							    {%endif%}
							   {% if profile.city %}
							    	<span class="locality">{{profile.city}}</span>
							    {%endif%}
							    {% if profile.state %}
							    	<span class="region">, {{profile.state}}</span>
							    {%endif%}
							    {% if profile.zipcode %}
							    	<span class="postal-code">, {{profile.zipcode}}</span>
							    {%endif%}
							     {% if profile.country %}
							    	<span class="country">, {{profile.country}}</span>
							    {%endif%}
						    </address>
					  </div>
				  </div>
				{% endif %}
			{% endif %}    
			  
			{% if profile.company or profile.position_title or profile.position_assignment %}
				<div class="work-info profile-section">
			    <h2>{% trans "Work Info" %}</h2>
			    	<table class="section-items">
				    {% if profile.company %}
				    	<tr>
				    	<td class="type">{% trans "Company:" %}</td> <td class="items">
				    	<span class="item">
				    	{{profile.company}}
				    	</span>
				    	</td>
				    	</tr>
				    {%endif%}
				    {% if profile.position_title %}
				    	<tr>
				    	<td class="type">{% trans "Position Title:" %}</td> <td class="items"> 
				    	<span class="item">
				    	{{profile.position_title}} 
				    	</span>
				    	</td>
				    	</tr>
				    {%endif%}
				    {% if profile.position_assignment %}
				    	<tr>
				    	<td class="type">{% trans "Position Assignment:" %}</td> <td class="items"> 
				    	<span class="item">
				    	{{profile.position_assignment}} 
				    	</span>
				    	</td>
				    	</tr>
				    {%endif%}
				  </table>
				 </div>
			  {%endif%}
			 
		</div>
		<div class="clear-both"></div>
		
		 <div class="profile-bottom">
		 	{% if profile.notes %}
               <div class="user-notes profile-section">
                   <h2>{% trans "Notes" %}</h2>
                   <p>{{ profile.notes  }}</p>
               </div>
              {%endif%}
              
            {% if isadmin %}
              <div class="admin-section">
	              	<h2>{% trans "Admin Section" %}</h2>
	              	
	              	<div class="column">
	                     <h3>{% trans "Tools:" %}</h3>
	                     <a href="{% url auth_password_change user_this.id %}"><em>{% trans "Reset Password" %}</em></a>
                     </div>  
                    
                    <div class="column">
	                     <h3>{% trans "Site Activity:" %}</h3>
	                     <a href="{% url event_log.search %}?q={{user_this.username}}">{% trans "View Eventlogs" %}</a>
                     </div> 
	              	
	              	<div class="column">
	              	 	{% if profile.entity %}
		                  <h3>{% trans "Entity:" %}</h3>
		                      <a href="{% url entity profile.entity.id %}">{{ profile.entity.entity_name }}</a>
	                	{% endif %} 
	                </div>
	                
	                <div class="clear-both"></div>
	                
	                <p><b>Record Owner(s):</b> <a href="{% url profile profile.owner_username %}">{{ profile.owner_username }}</a>
	                {% if additional_owners %}
	                	{% for owner in additional_owners %}
	                		&nbsp;&nbsp;&nbsp;<a href="{% url profile owner.username %}">{{ owner.username }}</a>
	                	{% endfor %}
	                 {% endif %}
                       
                    </p>
	                
	                {%if profile.admin_notes != "" %}
                         <p><b>{% trans "Notes:" %} </b>{{ profile.admin_notes }}</p>
                    {% endif %} 
              </div>
            {% endif %} 
            
            {% include "profiles/meta.html" %}
            
		 </div>
		
    </div>
{%if user_this.is_active %}
	<div id="userview-contributions">
		{% latest_contributions user_this as contributions %}
		<div class="latest-contributions">
			<h3>{% trans "Latest Contributions" %}</h3>
				{% if  contributions %}
					{% for contribution in contributions %}
					<div class="contribution">
						<div class="content-type">{{ contribution.content_type.name|capfirst }}</div>
						<div class="contrib-title">
							<a href="{{ contribution.object.get_absolute_url }}">{{ contribution.title }}</a>
						</div>
						<div class="contrib-create-dt">{{ contribution.create_dt|date:"long" }}</div>
						<div style="clear:both;"></div>
					</div>
					{% endfor %}
				{% else %}
					<div>{% trans "No contributions found." %}</div>
				{% endif %}
		</div>
	</div>
{% endif %}
	
	
	<div id="userview-groups">
		{% if can_edit_user %}
			<div><a href="{% url profile.edit_groups user_this.username %}">{% trans "Edit Available Groups" %}</a></div>
		{% endif %}
		
		{% if group_memberships %}
			<div class="group">
				<div class="content-type"><b>{% trans "Group" %}</b></div>
				<div class="content-title"><b>{% trans "Role" %}</b></div>
				<div class="clear-both"></div>
			</div>
			{% for gm in group_memberships %}
				<div class="group">
					<div class="content-type"><a href="{% url group.detail gm.group.slug %}">{{ gm.group.label }} ({{gm.group.name}})</a></div>
					<div class="content-title">{{ gm.role }} {% if can_edit_user %}(<a href="{% url profile.edit_role user_this.username gm.id %}">Edit</a>) {% endif %}</div>
					<div class="clear-both"></div>
				</div>
			{% endfor %}
		{% else %}
			<p>Not in any group.</p>
		{% endif %}
	</div>

    <div id="userview-memberships">
        {% if can_edit_user %}
			<div><a href="{% url profile.add_membership user_this.username %}">{% trans "Add Membership" %}</a></div>
		{% endif %}
        {% for membership in memberships %}
        <div class="membership-wrap">
        	<div><strong>{{ membership.member_number }}</strong></div>
            <div>{% trans "Membership Type:" %} <strong>{{ membership.membership_type }}</strong></div>
            <div>{% trans "Joined:" %} <strong>{{ membership.subscribe_dt|date }} ({{ membership.subscribe_dt|timesince }})</strong></div>

            {% if membership.expire_dt %}
	            <div>{% trans "Expires:" %} <strong>{{ membership.expire_dt|date }}</strong></div>
				{% renew_button %}
            {% else %}
                <div>{% trans "Never Expires" %}</div>
            {% endif %}

            {% if membership.get_entry %}
            <div>Entry: <strong><a href="{{ membership.get_entry.get_absolute_url }}">Link to Membership Entry</a></strong></div>
            {% endif %}

        </div>
        {% empty %}
            <p>No memberships.</p>
        {% endfor %}
    </div>

</div>

</div></div>

{% endblock %}

{% block extra_body %}
{{ block.super }}
{# dynamically load jquery #}
<script>
	if (!(window.jQuery)) { 
		var s = document.createElement('script');
		s.setAttribute('src', '/site_media/static/js/jquery-1.4.2.min.js'); 
		s.setAttribute('type', 'text/javascript');
		document.getElementsByTagName('head')[0].appendChild(s);}
</script>
<script type="text/javascript" src="/site_media/static/js/jquery_tabs/jquery-ui-1.8.custom.min.js"></script>

<script type="text/javascript" src="/site_media/static/js/global/dropdown.js"></script>
<script type="text/javascript">
$(document).ready(function(){
    if(document.location.hash != ""){window.scrollTo(0,0);}
	var $tabs = $("#userview-tabs").tabs();
}); 

var iconrow = new dropdown({
	container:	'more-options-wrap',
	trigger:	'more-options-trigger',
	target:		'more-options-target'
});
</script>

{% endblock %}
