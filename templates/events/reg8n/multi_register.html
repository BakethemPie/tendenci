{% extends "events/base-wide.html" %}
{% load event_tags %}
{% load styled_forms %}
{% load base_filters %}

{% block title %}{{ block.super }}Register{% endblock %}

{% block extra_head %}
{{ block.super }}
<link rel="stylesheet" href="{{ STATIC_URL }}css/events.css">
{% endblock %}

{% block body %}

<style type="text/css">

	.t h1 {
		margin-bottom: 0;
	}
	.t div.event-title {
		font-size: 1.2em;
		margin-bottom: 10px;
	}

	.price {
		font-size: 1.6em;
		margin-bottom: 10px;
		background-color: #FFC;
		padding: 10px;
	}
	
	.hidden{
		display: none;
	}
	
	.registrant-header{
		border-bottom: 1px dotted #ccc;
		margin: 2em 0 1em;
		padding: 5px 8px;
		font-weight: bold;
	}
	.even-registrant, .odd-registrant{
		background-color: #f5f5f5;
		padding: 10px;
	}
	.event-price-display{
		background-color: #ffffcc;
		font-size: 1.6em;
		margin-bottom: 10px;
		padding: 10px;
		width: 10em;
	}
	#reg-form-box{
	
		border: 1px solid #ccc;
		background-color: #fff;
		padding: 1em;
		-moz-border-radius: 8px;
		border-radius: 8px;
		width: 200px;
		
	}
	#reg-form-box input[type="text"]{
		width: 150px;
	}
	#reg-form-wrap{
		float: right;
		width: 200px;
		margin:2px;
	}
	#registrant-forms{
		width: 70%;
	}
	
	#reg-summary{
		font-weight: bold;
		font-size: 1.2em;
		margin-bottom: 1em;
		border-bottom: 1px solid silver;
	}
	#summary-total-price{
		border-top: 1px solid #ccc;
	}
	#total-label,#total-amount{ 
		font-weight: bold;
	}
	#summary-total-price{
		margin-bottom: 1em;
	}
	#summary-price, #summary-total-price{
		width: 90%;
	}
	#summary-price td, #summary-total-price td{
		padding: 3px;
	}
	#register-button{
		background-color: lightblue;
		font-weight: bold;
		font-size: 1.2em;
		
	}
	div.delete-button-wrap{
		display: none;
	}
	
	#update_summary{
		margin-bottom: 1em;
		padding: 3px;
	}
	
	.errors-box{
		background-color: #FFEBE8;
		border: 2px solid #FF8B78;
		margin-bottom: 20px;
		padding: 10px;
		width: 80%;
	}
	.deleted-item td{
		text-decoration: line-through;
	}
	.clear{
		clear: both;
	}

</style>

<div class="t">    
    {% event_nav user %}
    <h1>Register for Event - <a href="{% url event event.id %}">{{ event.title }}</a></h1>
		<div class="event-price-display">
		Price:
		{{ event.registration_configuration.price|format_currency }}</div>
		
	{% if reg_form.errors.values or has_registrant_form_errors %}
		<div class="errors-box">
			<ul>
				{{ reg_form.non_field_errors }}
				{% for field in reg_form %}
					{% if field.errors %}
						<li><a href="javascript:;">{{ field.label_tag }}</a></li>	
					{% endif %}
				{% endfor %}
				
				{% for form in registrant.forms %}
					{{ form.non_field_errors }}
					{% for field in form %}
						{% if field.errors %}
							<li><a href="javascript:;">{{ field.label_tag }}</a></li>	
						{% endif %}
					{% endfor %}
				{% endfor %}
			</ul>
		</div>
	{% endif %}

	<div class="form-wrap">
    	<form action="" method="post">
    	<div class="forms">
    	
    		<div id="reg-form-wrap">
    			<div class="float-anchor"><!-- ie7 fix --></div>
                <div class="float-window">
                
				<div id="reg-form-box">	
    				<div id="reg-summary">Summary</div>
    			
    				{# price list #}
    				<table id="summary-price">
    					{% for price_entry in price_list %}
    					<tr id="price_registrant_{{ forloop.counter }}"{% if price_entry.deleted %} class="deleted-item"{% endif %}>
	    					<td width="50%">Reg#<span class="item-counter">{{ forloop.counter }}</span></td>
	    					<td width="50%" align="right">
		    					<span class="currency-symbol">{{ SITE_GLOBAL_CURRENCYSYMBOL }}</span>
		    					<span class="reg-price">{{ price_entry.price}}</span>
	    					</td>
    					</tr>
    					{% endfor %}
    				</table>
    				<table id="summary-total-price">
    					<tr>
    						<td><div id="total-label">Total</div></td>
    						<td align="right">
    							<span class="currency-symbol">{{ SITE_GLOBAL_CURRENCYSYMBOL }}</span>
    							<span id="total-amount">{{ total_price }}</span>
    						</td>
    					</tr>
    				</table>
    			
    			
    			<noscript>
    			<div>
    				<input title="Update Summary" type="submit" id="update_summary" name="update_summary" value="Update Summary" />
				</div>
    			</noscript>
    			
   				{% if reg_form.payment_method %}
					<div class="form-field">
						<div class="error">{{ reg_form.payment_method.errors }}</div>
						<div class="required">Payment Method</div>
						<div class="field">{{ reg_form.payment_method }}</div>
					</div>
				{% endif %}
				
				{% if reg_form.captcha %}
					<div class="form-field">
						<div class="error">{{ reg_form.captcha.errors }}</div>
						<div class="required">Type the Code Below</div>
						<div class="field">{{ reg_form.captcha }}</div>
					</div>
				{% endif %}
   				<input type="submit" name="submit" id="register-button" value="{% if free_event %}Register{%else%}Register & Pay{%endif%}" />
    		
    		   </div>
    		   </div>  {# float-widow#}
    		</div>
    		
    		<div id="registrant-forms">
	    		{{ registrant.management_form }}
				{% for form in registrant.forms %}
					{% with forloop.counter as forloop_counter %}
					<div id="registrant_{{ forloop.counter }}" class="registrant-form">
						<div class="registrant-header{% if total_regt_forms = 1 %} hidden{% endif %}">
							Registrant #<span class="item-counter">{{ forloop_counter }}</span>:
						</div>
					
						<div class="{% cycle 'odd-registrant' 'even-registrant'%}">
						
							{% if form.first_name %}
							<div class="form-field">
								<div class="error">{{ form.first_name.errors }}</div>
								<div class="label{% if forloop_counter == 1 %} required{% endif %}">First Name</div>
								<div class="field">{{ form.first_name }}</div>
							</div>
							{% endif %}
				
							{% if form.last_name %}
							<div class="form-field">
								<div class="error">{{ form.last_name.errors }}</div>
								<div class="label{% if forloop_counter == 1 %} required{% endif %}">Last Name</div>
								<div class="field">{{ form.last_name }}</div>
							</div>
							{% endif %}
				
				        	{% if form.company_name %}
							<div class="form-field">
								<div class="error">{{ form.company_name.errors }}</div>
								<div class="label">Company</div>
								<div class="field">{{ form.company_name }}</div>
							</div>
							{% endif %}
				
							{% if form.phone %}
							<div class="form-field">
								<div class="error">{{ form.phone.errors }}</div>
								<div class="label">Phone</div>
								<div class="field">{{ form.phone }}</div>
							</div>
							{% endif %}
				
							{% if form.email %}
							<div class="form-field">
								<div class="error">{{ form.email.errors }}</div>
								<div class="label{% if forloop_counter == 1 %} required{% endif %}">Email</div>
								<div class="field">{{ form.email }}</div>
							</div>
							{% endif %}	
							
							
							{% if form.DELETE %}
							<div class="form-field delete{% if forloop.first %} hidden{% endif %}">
								<div class="delete-button-wrap">
									<button class="delete-button">Delete</button>
								</div>
								
								<noscript>
									<div>{{ form.DELETE }} Delete</div>
								</noscript>
							
							</div>
							{% endif %}	
							
						</div>	
					</div>
				{% endwith %}	
				{% endfor %}
				
			</div>
			
			<div class="add-registrant-box">
				 <input title='Add a registrant' type='submit' name='add_registrant' 
				 onClick="addRegistrant(this, 'registrant');return false;"
			 value='Add another registrant' />
			</div>
			
			<div class="clear"></div>
			
			<br />

		</div>
        </form>
	</div>

</div>
{% endblock %}

{% block extra_body %}
 <script type="text/javascript">

 	function deleteRegistrant(ele, prefix) {
		var registrant_form = $(ele).parents('.registrant-form');
		var attr_id = $(registrant_form).attr("id");

		// remove the registrant form
		$(registrant_form).remove();
		
		// update the TOTAL_FORMS
		var forms = $(".registrant-form");
		$("#id_" + prefix + "-TOTAL_FORMS").val(forms.length);

		// update the total amount and remove the reg price entry
		var reg_id = attr_id.split('_')[1];
		var registrant_summary_entry = $("tr[id=price_registrant_" + reg_id + "]");
		var registrant_price = $(registrant_summary_entry).find(".reg-price").html();
		
		var total_amount = $("#total-amount").html();
		total_amount = (parseFloat(total_amount) - parseFloat(registrant_price)).toFixed(2);
		$("#total-amount").html(total_amount);
		
		
		$(registrant_summary_entry).remove();
		
		// update form index
		var this_form;
		for (var i=0, formCount=forms.length; i<formCount; i++){
			this_form = forms.get(i);
			$(this_form).find(".form-field").children().children().each(function() {
				if (this){
					updateIndex(this, prefix, i);
				}
			});

			// update form header
			if (i > 0){
				updateFormHeader(this_form, prefix, i);
				updateSummary(this_form, prefix, i);
			}
		}

		return false;
	}

	function updateIndex(e, prefix, idx){
		var id_regex = new RegExp('(registrant-\\d+)');
		var replacement = prefix + '-' + idx
		if ($(e).attr("for")) 
			{$(e).attr("for", $(e).attr("for").replace(id_regex, replacement));}
		if (e.id) {e.id = e.id.replace(id_regex, replacement);}
		if (e.name){ e.name = e.name.replace(id_regex, replacement);}
	}

	// update the serial number on the form. ex: Registrant #3, Reg #3
	function updateFormHeader(this_form, prefix, idx){
		idx = idx + 1;

		// change the serial number on the form
		var id_regex = new RegExp('(registrant_\\d+)');
		var replacement = prefix + '_' + idx
		if (this_form.id) {this_form.id = this_form.id.replace(id_regex, replacement);}

		var reg_header = $(this_form).find('.registrant-header');
		if (reg_header) {
			var ic = $(reg_header).find('.item-counter');
			if (ic) {
				$(ic).html(idx);}
		};
		
	}
	
	function updateSummary(this_form, prefix, idx){
		idx = idx + 1;
		// change the serial number in the summary
		var price_item = $('#summary-price').find('tr')[idx-1];
		if (price_item){
			if (price_item.id){
				price_item.id = 'price_registrant_' + idx;
				var item_counter = $(price_item).find('.item-counter');
				if (item_counter) {$(item_counter).html(idx);}
			}
		}	
	}
	function addSummaryEntry(this_form, prefix, idx){
		idx = idx + 1;
		var row = $('#summary-price').find('tr:first').clone(true).get(0);
		$(row).find('.item-counter').html(idx);

		var id_regex = new RegExp('(registrant_\\d+)');
		var replacement = prefix + '_' + idx
		if (row.id) {row.id = row.id.replace(id_regex, replacement);}
		
		$(row).insertAfter($('#summary-price').find('tr:last'))
		// update the total
		var total_amount = $("#total-amount").html();
		total_amount = (parseFloat(total_amount) + parseFloat($(row).find(".reg-price").html())).toFixed(2);
		$("#total-amount").html(total_amount);
	}

	function addRegistrant(ele, prefix) {
		var formCount = parseInt($('#id_' + prefix + '-TOTAL_FORMS').val());
		var row = $('.registrant-form:first').clone(true).get(0);
		$('.registrant-form:first').find('.registrant-header').removeClass('hidden');
		$(row).insertAfter($('.registrant-form:last')).find('.hidden').removeClass('hidden');
		// remove the error
		$(row).find('div.error').remove();
		// remove required att
		$(row).find('div.label').removeClass("required");
		// update id attr
		var id_regex = new RegExp('(registrant_\\d+)');
		var replacement = prefix + '_' + formCount
		if (row.id) {row.id = row.id.replace(id_regex, replacement);}
		
		$(row).find(".form-field").children().children().each(function() {
			updateIndex(this, prefix, formCount);
    	    $(this).val('');
        });
        

		$('#id_' + prefix + '-TOTAL_FORMS').val(formCount + 1);

		updateFormHeader(row, prefix, formCount);

		addSummaryEntry(row, prefix, formCount);

		return false;
		

	}
	
	$(document).ready(function(){
		// show delete-button-wrap
		$(".delete-button-wrap").show();
		
		
		// delete confirmation
		$('button.delete-button').click(function(){
			var delete_confirm = confirm('Are you sure you want to delete this registrant?');	// confirm
			if(delete_confirm) {
					return deleteRegistrant(this, 'registrant');
			}
			return false;	// cancel
		});

		
	});

	$(window).scroll(function(){
		if  ($(window).scrollTop() > $(".float-anchor").offset().top){
			$(".float-window").css("position", "fixed");
			$(".float-window").css("top", "8px");
		}
		
		if  ($(window).scrollTop() <= $(".float-anchor").offset().top){
			$(".float-window").css("position", "relative");
			$(".float-window").css("top", $(".float-anchor").offset);
		}
	});


   </script>
{% endblock %}