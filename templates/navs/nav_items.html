{% extends 'navs/base-wide.html' %}
{% load nav_tags %}
{% load perm_tags %}
{% load styled_forms %}
{% load i18n %}

{% block title %}{{ block.super }} {% trans "Items" %}{% endblock title %}

{% block extra_head %}
{{ block.super }}
<link rel="stylesheet" href="{{ STATIC_URL }}css/navs.css">
{% endblock %}

{% block body %}

<div class="t">
	{% nav_nav request.user nav %}
    <h1>{% trans "Items" %} for {{ nav.title }}</h1>
    
    <div class="nav-wrap">
        <div class="nav-edit-menu">
            <h2>{{ page_select.pages.label }}</h2>
            Search:<input id="search-box" type="text">
            <form method="post" action="{% url navs.page_select %}" id="page-select">
                <div class="forms">{% csrf_token %}
                <div class="page-select">
                    {{ page_select.pages }}
                </div>
                <p>Select pages above to be added to Main Nav</p>
                <input class="nav-add" type="submit" value="{% trans 'Add to' %} {{ nav.title }}" />
                </div>
            </form>
        </div>
        <div class="nav-edit-content">
            <form method="post" action="">{% csrf_token %}
                {{ formset.management_form }}
                <div id="nav-items">
                {% for form in formset.forms %}
                <div class="nav-item" {% if forloop.first %}id="first-item"{% endif %}>
                    {{ form.id }}
                    <a href="#" class="nav-item-label">
                        <h2>+ {{ form.instance.label }}</h2>
                    </a>
                    <div class="nav-item-detail">
                        {% if form.non_field_errors %}
                            <div class="errors">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}
                        <div class="nav-item-left">
                            <div class="nav-item-field">
                                URL: <input class="url-field" disabled="disabled" type="text" value="{{ form.instance.page.get_absolute_url }}">
                            </div>
                            <div class="nav-item-field">
                                {% if form.label.errors %}
                                    <div class="errors">
                                        {{ form.label.errors }}
                                    </div>
                                {% endif %}
                                {{ form.label.label }}
                                {{ form.label }}
                            </div>
                        </div>
                        <div class="nav-item-right">
                            <div class="nav-item-field">
                                {% if form.title.errors %}
                                    <div class="errors">
                                        {{ form.title.errors }}
                                    </div>
                                {% endif %}
                                {{ form.title.label }}
                                {{ form.title }}
                            </div>
                            <div class="nav-item-field">
                                {% if form.css.errors %}
                                    <div class="errors">
                                        {{ form.css.errors }}
                                    </div>
                                {% endif %}
                                {{ form.css.label }}
                                {{ form.css }}
                            </div>
                        </div>
                        <div style="display: none;" >
                            {{ form.ordering }}
                            {{ form.level }}
                            {{ form.page }}
                        </div>
                        <a href="#" class="item-delete">Remove</a>
                    </div>
                </div>
            {% endfor %}
            </div>
            <input type="submit" value="Save">
            </form>
        </div>
        <div style="clear:both"></div>
        <!-- The next div is a base template for the form in form sets -->
        <div class="nav-item" id="base"> 
            <input type="hidden" name="form-0-id" id="id_form-0-id" /> 
            <a href="#" class="nav-item-label"> 
                <h2>+ </h2> 
            </a> 
            <div class="nav-item-detail"> 
                <div class="nav-item-left">
                <div class="nav-item-field"> 
                    URL: <input class="url-field" disabled="disabled" type="text" value=""> 
                </div> 
                <div class="nav-item-field"> 
                    
                    Label
                    <input id="id_form-0-label" type="text" name="form-0-label" maxlength="100" /> 
                </div> 
                </div>
                <div class="nav-item-right">
                <div class="nav-item-field"> 
                    
                    Title Attribute
                    <input id="id_form-0-title" type="text" name="form-0-title" maxlength="100" /> 
                </div> 
                <div class="nav-item-field"> 
                    
                    CSS Class
                    <input id="id_form-0-css" type="text" name="form-0-css" maxlength="100" /> 
                </div> 
                </div>
                <div style="display: none;" >
                    <input type="hidden" name="form-0-ordering" value="0" id="id_form-0-ordering" /> 
                    <input type="hidden" name="form-0-level" value="2" id="id_form-0-level" /> 
                    <input type="text" name="form-0-page" id="id_form-0-page" /> 
                </div> 
                <a class="item-delete">Remove</a> 
            </div> 
        </div> 
    </div>
</div>
{% endblock body %}

{% block extra_body %}
    {{ block.super }}
    <script type="text/javascript">
        $('#search-box').keypress(function(){
            // hide all pages that do not match search-box's value
            val = $('#search-box').val();
            pages = $('.page-select li');
            for(i=0;i<pages.length;i++){
                if($(pages[i]).html().indexOf(val)==-1){
                    $(pages[i]).hide();
                }else{
                    $(pages[i]).show();
                }
            }
        });
    </script>
    <script type="text/javascript">
        $('#base').hide();
        $('.nav-item-detail').hide();
        function updateElementIndex(el, prefix, ndx) {
            var id_regex = new RegExp('(' + prefix + '-\\d+)');
            var replacement = prefix + '-' + ndx;
            if ($(el).attr("for")) $(el).attr("for", $(el).attr("for").replace(id_regex, replacement));
            if (el.id) el.id = el.id.replace(id_regex, replacement);
            if (el.name) el.name = el.name.replace(id_regex, replacement);
        }
        apply_delete = function(thing){
            thing.click(function(){
                total = $("#id_form-TOTAL_FORMS").val();
                $(this).parent().parent().remove();
                items = $("#nav-items").find(".nav-item")
                for(i=0;i<total-1;i++){
                    inputs = $(items[i]).find('input');
                    for(j=0;j<inputs.length;j++){
                        updateElementIndex(inputs[j], 'form', i);
                    }
                }
                $("#id_form-TOTAL_FORMS").val(total-1);
                return false;
            });
        }
        apply_toggle = function(thing){
            thing.click(function(){
                $(this).parent().find('.nav-item-detail').toggle();
                str = $(this).html()
                if (str.indexOf("+") >= 0) {
                    $(this).html(str.replace('+', '-'));
                } else {
                    $(this).html(str.replace('-', '+'));
                }
                return false;
            });
        }
        apply_toggle($('.nav-item-label'));
        apply_delete($('.item-delete'));
    </script>
    <script type="text/javascript" src="{{ STATIC_URL }}/js/jquery.form.js"></script>
    <script type="text/javascript">
        //when pages are chosen to be included in the nav an ajax call will be triggered
        //the ajax will retrieve info from the chosen pages and then append additional forms
        //into the nav item form set.
        $(document).ready(function() {
            var options = {
                success: showResponse,
                error: showResponse,
                dataType: 'json',
                clearForm: true,
                resetForm: true,
            };
            $('#page-select').ajaxForm(options);
        });
        
        function showResponse(response, status, xhr, $form)  { 
            if (response.error) {
                alert("An error occured");
            } else {
                form_number = parseInt($("#id_form-TOTAL_FORMS").val())
                pages = response.pages
                for(i=0;i<pages.length;i++){
                    items = $("#nav-items");
                    item = $("#base");
                    //copy the template form
                    clone = item.clone();
                    //customize the form based on the page info
                    clone.attr('id', '')
                    clone.show();
                    clone.find('#id_form-0-id').remove();
                    clone.find('.url-field').val(pages[i].url);
                    clone.find('#id_form-0-label').val(pages[i].label);
                    clone.find('.nav-item-label h2').html("+ "+pages[i].label);
                    clone.find('#id_form-0-page').val(pages[i].id);
                    clone.find('#id_form-0-title').val(pages[i].label);
                    
                    //relace the names and ids of the elements in the form
                    //clone.find('#id_form-0-id').attr('name', 'form-' + form_number + '-id');
                    clone.find('#id_form-0-label').attr('name', 'form-' + form_number + '-label');
                    clone.find('#id_form-0-title').attr('name', 'form-' + form_number + '-title');
                    clone.find('#id_form-0-css').attr('name', 'form-' + form_number + '-css');
                    clone.find('#id_form-0-page').attr('name', 'form-' + form_number + '-page');
                    clone.find('#id_form-0-ordering').attr('name', 'form-' + form_number + '-ordering');
                    clone.find('#id_form-0-level').attr('name', 'form-' + form_number + '-level');
                    
                    //clone.find('#id_form-0-id').attr('id', 'id_form-' + form_number + '-id');
                    clone.find('#id_form-0-label').attr('id', 'id_form-' + form_number + '-label');
                    clone.find('#id_form-0-title').attr('id', 'id_form-' + form_number + '-title');
                    clone.find('#id_form-0-css').attr('id', 'id_form-' + form_number + '-css');
                    clone.find('#id_form-0-page').attr('id', 'id_form-' + form_number + '-page');
                    clone.find('#id_form-0-ordering').attr('id', 'id_form-' + form_number + '-ordering');
                    clone.find('#id_form-0-level').attr('id', 'id_form-' + form_number + '-level');
                    
                    //apply the toggle effect
                    apply_toggle(clone.find('.nav-item-label'));
                    apply_delete(clone.find('.item-delete'));
                    //append to the formset
                    items.append(clone);
                    //increment id count
                    form_number++;
                }
                $("#id_form-TOTAL_FORMS").val(form_number);
            }
        }
    </script>
{% endblock %}
