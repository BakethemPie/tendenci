{% extends 'navs/base-wide.html' %}
{% load nav_tags %}
{% load perm_tags %}
{% load styled_forms %}
{% load i18n %}

{% block title %}{{ block.super }} {% trans "Items" %}{% endblock title %}

{% block extra_head %}
{{ block.super }}
<link rel="stylesheet" href="{{ STATIC_URL }}css/navs.css">
{% endblock %}

{% block body %}

<div class="t">
	{% nav_nav request.user nav %}
    <h1>{% trans "Items" %} for {{ nav.title }}</h1>
    
    <div class="nav-wrap">
        <div class="nav-edit-menu">
            <form method="post" action="{% url navs.page_select %}" id="page-select">
            <div class="forms">{% csrf_token %}
                <h2>{{ page_select.pages.label }}</h2>
                <div class="page-select">
                    {{ page_select.pages }}
                </div>
                <input class="nav-add" type="submit" value="{% trans 'Add to' %} {{ nav.title }}" />
            </div>
            </form>
        </div>
        <div class="nav-edit-content">
            <form method="post" action="">{% csrf_token %}
                {{ formset.management_form }}
                <div id="nav-items">
                {% for form in formset.forms %}
                <div class="nav-item">
                    {{ form.id }}
                    <a href="#" class="nav-item-label">
                        <h2>+ {{ form.instance.label }}</h2>
                    </a>
                    <div class="nav-item-detail">
                        {% if form.non_field_errors %}
                            <div class="errors">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}
                        <div class="nav-item-field">
                            URL: <input class="url-field" disabled="disabled" type="text" value="{{ form.instance.page.get_absolute_url }}">
                        </div>
                        <div class="nav-item-field">
                            {% if form.label.errors %}
                                <div class="errors">
                                    {{ form.label.errors }}
                                </div>
                            {% endif %}
                            {{ form.label.label }}
                            {{ form.label }}
                        </div>
                        <div class="nav-item-field">
                            {% if form.title.errors %}
                                <div class="errors">
                                    {{ form.title.errors }}
                                </div>
                            {% endif %}
                            {{ form.title.label }}
                            {{ form.title }}
                        </div>
                        <div class="nav-item-field">
                            {% if form.css.errors %}
                                <div class="errors">
                                    {{ form.css.errors }}
                                </div>
                            {% endif %}
                            {{ form.css.label }}
                            {{ form.css }}
                        </div>
                        <div class="nav-item-field">
                            {% if form.ordering.errors %}
                                <div class="errors">
                                    {{ form.ordering.errors }}
                                </div>
                            {% endif %}
                            {{ form.ordering.label }}
                            {{ form.ordering }}
                        </div>
                        <div class="nav-item-field">
                            {% if form.level.errors %}
                                <div class="errors">
                                    {{ form.level.errors }}
                                </div>
                            {% endif %}
                            {{ form.level.label }}
                            {{ form.level }}
                        </div>
                        <div style="display: none;" >
                            {{ form.page }}
                        </div>
                    </div>
                </div>
            {% endfor %}
            </div>
            <input type="submit" value="Save">
            </form>
        </div>
        <div style="clear:both"></div>
    </div>
</div>
{% endblock body %}

{% block extra_body %}
    {{ block.super }}
    <script type="text/javascript">
        $($.find('.nav-item-detail')).hide()
        apply_toggle = function(thing){
            thing.click(function(){
                $(this).parent().find('.nav-item-detail').toggle();
                str = $(this).html()
                if (str.indexOf("+") >= 0) {
                    $(this).html(str.replace('+', '-'));
                } else {
                    $(this).html(str.replace('-', '+'));
                }
                return false;
            });
        }
        apply_toggle($($.find('.nav-item-label')));
    </script>
    <script type="text/javascript" src="{{ STATIC_URL }}/js/jquery.form.js"></script>
    <script type="text/javascript">
        //when pages are chosen to be included in the nav an ajax call will be triggered
        //the ajax will retrieve info from the chosen pages and then append additional forms
        //into the nav item form set.
        $(document).ready(function() {
            var options = {
                success: showResponse,
                error: showResponse,
                dataType: 'json',
                clearForm: true,
                resetForm: true,
            };
            $('#page-select').ajaxForm(options);
        });
        
        function showResponse(response, status, xhr, $form)  { 
            if (response.error) {
                alert("An error occured");
            } else {
                form_number = $("#id_form-TOTAL_FORMS").val()
                pages = response.pages
                for(i=0;i<pages.length;i++){
                    items = $($.find("#nav-items"));
                    item = $(items.find(".nav-item")[0]);
                    //clone the first form
                    clone = item.clone();
                    //customize the form based on the page info
                    clone.find('#id_form-0-id').val(pages[i].id);
                    clone.find('.url-field').val(pages[i].url);
                    clone.find('#id_form-0-label').val(pages[i].label);
                    clone.find('.nav-item-label h2').html("+ "+pages[i].label);
                    clone.find('#id_form-0-page').val(pages[i].id);
                    
                    //relace the names and ids of the elements in the form
                    clone.find('#id_form-0-id').attr('name', 'placeholder' + form_number);
                    clone.find('#id_form-0-label').attr('name', 'placeholder' + form_number);
                    clone.find('#id_form-0-title').attr('name', 'placeholder' + form_number);
                    clone.find('#id_form-0-css').attr('name', 'placeholder' + form_number);
                    clone.find('#id_form-0-page').attr('name', 'placeholder' + form_number);
                    clone.find('#id_form-0-ordering').attr('name', 'placeholder' + form_number);
                    clone.find('#id_form-0-level').attr('name', 'placeholder' + form_number);
                    
                    clone.find('#id_form-0-id').attr('id', 'placeholder' + form_number);
                    clone.find('#id_form-0-label').attr('id', 'placeholder' + form_number);
                    clone.find('#id_form-0-title').attr('id', 'placeholder' + form_number);
                    clone.find('#id_form-0-css').attr('id', 'placeholder' + form_number);
                    clone.find('#id_form-0-page').attr('id', 'placeholder' + form_number);
                    clone.find('#id_form-0-ordering').attr('id', 'placeholder' + form_number);
                    clone.find('#id_form-0-level').attr('id', 'placeholder' + form_number);
                    
                    //apply the toggle effect
                    apply_toggle(clone.find('.nav-item-label'));
                    //append to the formset
                    items.append(clone);
                }
            }
        }
    </script>
{% endblock %}
