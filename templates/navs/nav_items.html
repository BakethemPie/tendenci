{% extends 'navs/base-wide.html' %}
{% load nav_tags %}
{% load perm_tags %}
{% load styled_forms %}
{% load i18n %}

{% block title %}{{ block.super }} {% trans "Items" %}{% endblock title %}

{% block extra_head %}
{{ block.super }}
<link rel="stylesheet" href="{{ STATIC_URL }}css/navs.css">
{% endblock %}

{% block body %}

<div class="t">
	{% nav_nav request.user current_nav %}
    
    <div class="nav-wrap">
        <div class="nav-edit-menu">
            <h3>{{ page_select.pages.label }} {% trans 'list' %}</h3>
            <p>{% trans 'Select pages below to be added to' %} {{ current_nav.title }}. {% trans 'Use the search box to filter the list of pages' %}.</p>
            {% trans 'Search' %}: <input id="navs-search-box" type="text" />
            <form method="post" action="{% url navs.page_select %}" id="page-select">
                <div class="forms">{% csrf_token %}
                <div class="page-select">
                    {{ page_select.pages }}
                </div>
                <input class="nav-add" type="submit" value="{% trans 'Add selected pages to' %} {{ current_nav.title }}" />
                </div>
            </form>
            <a id="add-custom" >{% trans 'Add a Custom Navigation Item' %}</a>
        </div>
        <div class="nav-edit-content">
        <h1>{% trans "Items" %} for {{ current_nav.title }}</h1>
            <form method="post" action="">{% csrf_token %}
                {{ formset.management_form }}
                <div id="nav-items">
                {% for form in formset.forms %}
                <div class="nav-item" {% if forloop.first %}id="first-item"{% endif %}>
                    <input type="hidden" name="form-{{ forloop.counter0 }}-id" id="id_form-{{ forloop.counter0 }}-id" /> 
                    <a href="#" class="nav-item-label">
                        + <span class="linklabel">{{ form.instance.label }}</span>&nbsp;<span class="helpertext">({% trans 'edit' %})</span>
                    </a>
                    <a href="#" class="nav-move-right">&rarr;</a>
                    <a href="#" class="nav-move-left">&larr;</a>
                    {% if form.errors %}
                        <div class="errors">{{ form.errors }}</div>
                    {% endif %}
                    <div class="nav-item-detail">
                        <table>
                        <tr>
                        <td>
                            <div class="nav-item-field">
                                {% if form.url.errors %}
                                    <div class="errors">
                                        {{ form.url.errors }}
                                    </div>
                                {% endif %}
                                {% if form.instance.page %}
                                    <label class="small-label">{% trans 'URL' %}</label> <input class="url-field" disabled="disabled" type="text" value="{{ form.instance.page.get_absolute_url }}">
                                {% else %}
                                    <label class="small-label">{{ form.url.label }}</label>
                                    {{ form.url }}
                                {% endif %}
                            </div>
                            <div class="nav-item-field">
                                {% if form.label.errors %}
                                    <div class="errors">
                                        {{ form.label.errors }}
                                    </div>
                                {% endif %}
                                <label class="small-label">{{ form.label.label }}</label>
                                {{ form.label }}
                            </div>
                        </div>
                        </td>
                        <td>
                            <div class="nav-item-field">
                                {% if form.title.errors %}
                                    <div class="errors">
                                        {{ form.title.errors }}
                                    </div>
                                {% endif %}
                                <label>{{ form.title.label }}</label>
                                {{ form.title }}
                            </div>
                            <div class="nav-item-field">
                                {% if form.css.errors %}
                                    <div class="errors">
                                        {{ form.css.errors }}
                                    </div>
                                {% endif %}
                                <label>{{ form.css.label }}</label>
                                {{ form.css }}
                            </div>
                        </td>
                        </tr>
                        </table>
                        <div style="display: none;" >
                            <div class="ordering">{{ form.ordering }}</div>
                            <div class="level">{{ form.level }}</div>
                            {{ form.page }}
                        </div>
                        <a href="#" class="item-delete">{% trans 'Remove' %}</a>
                    </div>
                </div>
            {% endfor %}
            </div>
            
            <input type="submit" id="save-all" value="{% trans 'Save All Navigation Items' %}">
            </form>
            
        </div>
        <div style="clear:both"></div>
        <!-- The next div is a base template for the form in form sets -->
        <div class="nav-item" id="base"> 
            <input type="hidden" name="form-0-id" id="id_form-0-id" /> 
            <a href="#" class="nav-item-label"><b>+ </b></a>
            <a href="#" class="nav-move-right">&rarr;</a>
            <a href="#" class="nav-move-left">&larr;</a>
            <div class="nav-item-detail">
                <table>
                <tr>
                <td>
                <div class="nav-item-field"> 
                    <label class="small-label">{% trans 'URL' %}</label>
                    <input class="url-field" id="id_form-0-url" type="text" name="form-0-url" maxlength="200" > 
                </div> 
                <div class="nav-item-field">
                    <label class="small-label">{% trans 'Label' %}</label>
                    <input id="id_form-0-label" type="text" name="form-0-label" maxlength="100" /> 
                </div> 
                </td>
                <td>
                <div class="nav-item-field">
                    <label>{% trans 'Title Attribute' %}</label>
                    <input id="id_form-0-title" type="text" name="form-0-title" maxlength="100" /> 
                </div> 
                <div class="nav-item-field">
                    <label>{% trans 'CSS Class' %}</label>
                    <input id="id_form-0-css" type="text" name="form-0-css" maxlength="100" /> 
                </div> 
                </td>
                </tr>
                </table>
                <div style="display: none;" >
                    <div class="ordering">
                        <input type="hidden" name="form-0-ordering" value="0" id="id_form-0-ordering" /> 
                    </div>
                    <div class="level">
                        <input type="hidden" name="form-0-level" value="0" id="id_form-0-level" /> 
                    </div>
                    <input type="text" name="form-0-page" id="id_form-0-page" /> 
                </div> 
                <a class="item-delete">{% trans 'Remove' %}</a> 
            </div> 
        </div> 
    </div>
</div>
{% endblock body %}

{% block extra_body %}
    {{ block.super }}
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery_ui_all_custom/jquery-ui-1.8.5.custom.min.js"></script>
    <script type="text/javascript">
        $('#navs-search-box').keyup(function(){
            // hide all pages that do not match search-box's value
            val = $('#navs-search-box').val().toLowerCase();
            pages = $('.page-select li');
            for(i=0;i<pages.length;i++){
                if($(pages[i]).html().toLowerCase().indexOf(val)==-1){
                    $(pages[i]).hide();
                }else{
                    $(pages[i]).show();
                }
            }
        });
    </script>
    <script type="text/javascript">
        //initialize the formset details and events
        //override and set the initial number of forms to be 0
        //this is to avoid some validation bugs with the dynamic add/delete
        //of the forms.
        initial = $("#id_form-INITIAL_FORMS").val(0);
        total = $("#id_form-TOTAL_FORMS").val();
        items = $("#nav-items").find(".nav-item");
        for(i=0;i<total;i++){
            level = $($(items[i]).find('.level input')).val();
            $(items[i]).css('margin-left', (level*20)+'px');
        }
        $('#base').hide();
        $('.nav-item-detail').hide();
        function updateElementIndex(el, prefix, ndx){
            var id_regex = new RegExp('(' + prefix + '-\\d+)');
            var replacement = prefix + '-' + ndx;
            if ($(el).attr("for")) $(el).attr("for", $(el).attr("for").replace(id_regex, replacement));
            if (el.id) el.id = el.id.replace(id_regex, replacement);
            if (el.name) el.name = el.name.replace(id_regex, replacement);
        }
        apply_delete = function(thing){
            thing.click(function(){
                total = $("#id_form-TOTAL_FORMS").val();
                $(this).parent().parent().remove();
                items = $("#nav-items").find(".nav-item");
                for(i=0;i<total-1;i++){
                    inputs = $(items[i]).find('input');
                    for(j=0;j<inputs.length;j++){
                        updateElementIndex(inputs[j], 'form', i);
                    }
                    $($(items[i]).find('#id_form-'+i+'-ordering')).val(i);
                }
                $("#id_form-TOTAL_FORMS").val(total-1);
                return false;
            });
        }
        apply_toggle = function(thing){
            thing.click(function(){
                $(this).parent().find('.nav-item-detail').toggle();
                $(this).find('.linklabel').html($(this).parent().find('input[name*="-label"]').val());
                str = $(this).html();
                console.log($(this).find('.linklabel').html());
                help_str = $(this).find(".helpertext").html();
                if (str.indexOf("-") >= 0) {
                    $(this).html(str.replace('-', '+'));
                    $(this).find(".helpertext").html(help_str.replace('collapse', 'edit'));
                }
                if (str.indexOf("+") >= 0) {
                    $(this).html(str.replace('+', '-'));
                    $(this).find(".helpertext").html(help_str.replace('edit', 'collapse'));
                }
                return false;
            });
        }
        apply_move_left = function(thing){
            thing.click(function(){
                level = parseInt($($($(this).parent()).find('.level input')).val()) - 1;
                if (level > -1){
                    $($(this).parent()).css('margin-left', (level*20)+'px');
                    $($($(this).parent()).find('.level input')).val(level)
                }
                return false;
            });
        }
        apply_move_right = function(thing){
            thing.click(function(){
                level = parseInt($($($(this).parent()).find('.level input')).val()) + 1;
                if (level < 3){
                    $($(this).parent()).css('margin-left', (level*20)+'px');
                    $($($(this).parent()).find('.level input')).val(level);
                }
                return false;
            });
        }
        apply_toggle($('.nav-item-label'));
        apply_delete($('.item-delete'));
        apply_move_left($('.nav-move-left'));
        apply_move_right($('.nav-move-right'));
    </script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery.form.js"></script>
    <script type="text/javascript">
        //when pages are chosen to be included in the nav an ajax call will be triggered
        //the ajax will retrieve info from the chosen pages and then append additional forms
        //into the nav item form set.
        $(document).ready(function() {
            var options = {
                success: showResponse,
                error: showResponse,
                dataType: 'json',
                clearForm: true,
                resetForm: true,
            };
            $('#page-select').ajaxForm(options);
        });
        
        function showResponse(response, status, xhr, $form)  { 
            if (response.error) {
                alert("An error occured");
            } else {
                form_number = parseInt($("#id_form-TOTAL_FORMS").val())
                pages = response.pages
                for(i=0;i<pages.length;i++){
                    items = $("#nav-items");
                    item = $("#base");
                    //copy the template form
                    clone = item.clone();
                    //customize the form based on the page info
                    clone.attr('id', '')
                    clone.show();
                    clone.find('#id_form-0-id').removeAttr('value');
                    clone.find('.url-field').val(pages[i].url);
                    clone.find('#id_form-0-label').val(pages[i].label);
                    clone.find('.nav-item-label b').html("+ "+pages[i].label);
                    clone.find('#id_form-0-page').val(pages[i].id);
                    clone.find('#id_form-0-title').val(pages[i].label);
                    clone.find('#id_form-0-ordering').val(form_number);
                    clone.find('.url-field').attr('disabled', 'disabled');
                    
                    //relace the names and ids of the elements in the form
                    //clone.find('#id_form-0-id').attr('name', 'form-' + form_number + '-id');
                    clone.find('#id_form-0-id').attr('name', 'form-' + form_number + '-id');
                    clone.find('#id_form-0-label').attr('name', 'form-' + form_number + '-label');
                    clone.find('#id_form-0-title').attr('name', 'form-' + form_number + '-title');
                    clone.find('#id_form-0-css').attr('name', 'form-' + form_number + '-css');
                    clone.find('#id_form-0-page').attr('name', 'form-' + form_number + '-page');
                    clone.find('#id_form-0-ordering').attr('name', 'form-' + form_number + '-ordering');
                    clone.find('#id_form-0-level').attr('name', 'form-' + form_number + '-level');
                    
                    //clone.find('#id_form-0-id').attr('id', 'id_form-' + form_number + '-id');
                    clone.find('#id_form-0-id').attr('id', 'form-' + form_number + '-id');
                    clone.find('#id_form-0-label').attr('id', 'id_form-' + form_number + '-label');
                    clone.find('#id_form-0-title').attr('id', 'id_form-' + form_number + '-title');
                    clone.find('#id_form-0-css').attr('id', 'id_form-' + form_number + '-css');
                    clone.find('#id_form-0-page').attr('id', 'id_form-' + form_number + '-page');
                    clone.find('#id_form-0-ordering').attr('id', 'id_form-' + form_number + '-ordering');
                    clone.find('#id_form-0-level').attr('id', 'id_form-' + form_number + '-level');
                    
                    //apply the click effects
                    clone.find('.nav-item-label').html(clone.find('.nav-item-label').html()+"&nbsp;<span class='helpertext'>(edit)</span>");
                    apply_toggle(clone.find('.nav-item-label'));
                    apply_delete(clone.find('.item-delete'));
                    apply_move_left(clone.find('.nav-move-left'));
                    apply_move_right(clone.find('.nav-move-right'));
                    //append to the formset
                    items.append(clone);
                    //increment id count
                    form_number++;
                }
                $("#id_form-TOTAL_FORMS").val(form_number);
            }
        }
    </script>
    <script>
    //set the nav items to become sortable
    $(document).ready(function() {
        $("#nav-items").sortable({
            cursor: 'move',
            update: function(event, ui){
                    items = $(this).find('.nav-item');
                    for(i=0;i<items.length;i++){
                        input = $($(items[i]).find('.ordering input'));
                        input.attr('value', i);
                    }
                },
        });
    });
    </script>
    <script>
    //custom form add
    $(document).ready(function(){
        $('#add-custom').click(function(){
            form_number = parseInt($("#id_form-TOTAL_FORMS").val())
            items = $("#nav-items");
            item = $("#base");
            //copy the template form
            clone = item.clone();
            //set default values to the form
            clone.attr('id', '')
            clone.show();
            clone.find('.nav-item-detail').show();
            clone.find('#id_form-0-ordering').val(form_number);
            
            //relace the names and ids of the elements in the form
            //clone.find('#id_form-0-id').attr('name', 'form-' + form_number + '-id');
            clone.find('#id_form-0-id').attr('name', 'form-' + form_number + '-id');
            clone.find('#id_form-0-label').attr('name', 'form-' + form_number + '-label');
            clone.find('#id_form-0-title').attr('name', 'form-' + form_number + '-title');
            clone.find('#id_form-0-css').attr('name', 'form-' + form_number + '-css');
            clone.find('#id_form-0-page').attr('name', 'form-' + form_number + '-page');
            clone.find('#id_form-0-ordering').attr('name', 'form-' + form_number + '-ordering');
            clone.find('#id_form-0-level').attr('name', 'form-' + form_number + '-level');
            clone.find('#id_form-0-url').attr('name', 'form-' + form_number + '-url');
            
            //clone.find('#id_form-0-id').attr('id', 'id_form-' + form_number + '-id');
            clone.find('#id_form-0-id').attr('id', 'form-' + form_number + '-id');
            clone.find('#id_form-0-label').attr('id', 'id_form-' + form_number + '-label');
            clone.find('#id_form-0-title').attr('id', 'id_form-' + form_number + '-title');
            clone.find('#id_form-0-css').attr('id', 'id_form-' + form_number + '-css');
            clone.find('#id_form-0-page').attr('id', 'id_form-' + form_number + '-page');
            clone.find('#id_form-0-ordering').attr('id', 'id_form-' + form_number + '-ordering');
            clone.find('#id_form-0-level').attr('id', 'id_form-' + form_number + '-level');
            clone.find('#id_form-0-url').attr('id', 'id_form-' + form_number + '-url');
            
            //apply the click effects
            clone.find('.nav-item-label').html("- <span class='linklabel'>Item " + (form_number+1) + "</span>&nbsp;<span class='helpertext'>(collapse)</span>");
            apply_toggle(clone.find('.nav-item-label'));
            apply_delete(clone.find('.item-delete'));
            apply_move_left(clone.find('.nav-move-left'));
            apply_move_right(clone.find('.nav-move-right'));
            //append to the formset
            items.append(clone);
            //increment id count
            form_number++;
            $("#id_form-TOTAL_FORMS").val(form_number);
        });
    });
    </script>
{% endblock %}
